# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã Enum —Ç–∏–ø—ã (Type Safety)

**–§–∞–π–ª:** `prisma/schema.prisma`

–î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ enum –¥–ª—è:

- `Gender` - male, female, unspecified
- `FitnessLevel` - low, medium, high
- `TrainingFormat` - individual, group, mixed
- `ContactLevel` - nonContact, lightContact, fullContact

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤ TypeScript
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–ø–µ—á–∞—Ç–æ–∫
- ‚úÖ –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö

### 2. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**SurveySubmission:**

- `[gender, fitnessLevel]` - –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `[createdAt, gender]` - –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–∑–æ–≤
- `[telegramUserId]` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `[deletedAt]` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö

**RecommendationSnapshot:**

- `[sectionId, score]` - –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Å–µ–∫—Ü–∏–π
- `[createdAt]` - –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

**SportSection:**

- `[format, intensity]` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- `[contactLevel]` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç—É
- `[deletedAt]` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
- `[recommendationCount]` - –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏

### 3. Soft Deletes

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `deletedAt: DateTime?` –≤:

- `SurveySubmission`
- `SportSection`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ê—É–¥–∏—Ç —É–¥–∞–ª–µ–Ω–∏–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏

### 4. –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è

–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `SportSection`:

- `recommendationCount` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- `averageScore` - —Å—Ä–µ–¥–Ω–∏–π score
- `lastRecommendedAt` - –ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**

- PostgreSQL —Ç—Ä–∏–≥–≥–µ—Ä `update_section_stats()`
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ INSERT –≤ `RecommendationSnapshot`

### 5. –û—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞

**–û–±–Ω–æ–≤–ª–µ–Ω:** `src/types.ts`

- Re-export Prisma enum —Ç–∏–ø–æ–≤
- –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ string union —Ç–∏–ø—ã
- –£–ª—É—á—à–µ–Ω–∞ —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–û–±–Ω–æ–≤–ª–µ–Ω:** `src/recommendation/sectionRepository.ts`

- –£–±—Ä–∞–Ω—ã –Ω–µ–Ω—É–∂–Ω—ã–µ `as unknown as`
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `deletedAt: null`
- –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø–æ–ª–µ–π –≤–º–µ—Å—Ç–æ spread

**–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–ª–∞–≥–æ–¥–∞—Ä—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤
- JSON –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è —Å `as unknown` (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ Prisma)

## üìÅ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. `prisma/migrations/manual_add_enums_indexes_soft_deletes.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
2. `prisma/migrations/manual_rollback_enums_indexes_soft_deletes.sql` - –æ—Ç–∫–∞—Ç
3. `docs/MIGRATION_GUIDE.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ï—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ
bunx prisma migrate dev --name add-enums-indexes-soft-deletes

# –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å SQL –≤—Ä—É—á–Ω—É—é
psql -U your_user -d your_db < prisma/migrations/manual_add_enums_indexes_soft_deletes.sql
```

### Heroku –¥–µ–ø–ª–æ–π

```bash
# 1. –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø
heroku pg:backups:capture --app your-app-name

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
heroku pg:psql DATABASE_URL --app your-app-name < prisma/migrations/manual_add_enums_indexes_soft_deletes.sql

# 3. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥
git add .
git commit -m "refactor(db): add enums, indexes, and soft deletes"
git push heroku main
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- ‚ö° –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: **–¥–æ 5x –±—ã—Å—Ç—Ä–µ–µ** (–±–ª–∞–≥–æ–¥–∞—Ä—è —Å–æ—Å—Ç–∞–≤–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º)
- ‚ö° –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ–∫—Ü–∏–π: **–¥–æ 3x –±—ã—Å—Ç—Ä–µ–µ** (–∏–Ω–¥–µ–∫—Å—ã –Ω–∞ format/contactLevel)
- ‚ö° –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–µ–∫—Ü–∏–∏: **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è recommendationCount)

**–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- üõ°Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è enum
- üõ°Ô∏è TypeScript –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è –≤—Å–µ—Ö enum –ø–æ–ª–µ–π
- üõ°Ô∏è –û—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤–º–µ—Å—Ç–æ runtime –æ—à–∏–±–æ–∫

**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**

- üíæ Soft deletes - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- üíæ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- üíæ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ deletedAt –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

## ‚ö†Ô∏è Breaking Changes

**–ù–ï–¢** - –º–∏–≥—Ä–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞:

- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ string –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ enum
- TypeScript —Ç–∏–ø—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏
- API –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
bunx tsc --noEmit

# –¢–µ—Å—Ç—ã
bun test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
bun run test-db-connection.ts
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–°–º. —Ñ–∞–π–ª—ã:

- `docs/MIGRATION_GUIDE.md` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `prisma/schema.prisma` - –Ω–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î
- `src/types.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ TypeScript —Ç–∏–ø—ã
